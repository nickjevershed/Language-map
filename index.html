<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Interactive map | The Guardian </title>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.10.3.custom.min.css" />	
		<style type="text/css">
			body{
				margin:0px;
				padding:0px;
				font-family: Helvetica, Arial, "Lucida Grande", sans-serif; 
				font-size:11px;

			}

			#outer-wrapper{
				max-width: 860px;
				position: relative;
			}

			.state {
				fill:#FFF;
				fill-opacity: 1;
				stroke: #bfbfbf;
				/*stroke-width:.5px;*/

			}

			.graticule {
				fill: none;
				stroke: #efefef;
				stroke-width: .5px;
				stroke-opacity:1;
			}


			.circle {
				fill-opacity:.5;
				stroke-opacity:.5;
				stroke-width:.5px;
				stroke:grey;
			}

			.keyCircle {
				stroke-width:.5px;
				stroke:grey;
			}
			.circle:hover {

      		stroke: #000;
      		stroke-width:2px;
   			 }

   			#mapKey {
   				position: absolute;
   				left:1%;
   				top:1%;

   			}  


		</style>


	</head>
	<body>
	

		<div id="outer-wrapper">
			
			<div id="aust-map">
					
			</div>	
			
			<div id="mapKey">

			</div>

		</div>

		<script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
		<script type="text/javascript" src="js/d3.min.js"></script>
	    <script type="text/javascript" src="js/jquery-ui-1.10.3.custom.min.js"></script>

		
		<script type="text/javascript">

			
			
			//Get window width

			var getW = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
			var getH = getW/1.7;

			//Smaller graph for smaller screens

			if (getW > 860) {
				getW = 860;
			}

			function drawMap() {

				var austMap,mapKey;
				var projection,path,graticule;

				d3.select("#slangMap").remove();
				d3.select("#slangKey").remove();

				var width = getW;
				var height = getH;

				var maxRadius=14,radiusMultiplier;
				var keyHeight=60;

				var colours = ['#7fc97f','#beaed4','#fdc086','#386cb0','#f0027f'];

				projection = d3.geo.mercator()
					.rotate([-132.8,25.776])
					.scale(width*1.4)
					.translate([width/6,height/6])

				path = d3.geo.path()
					.projection(projection);

				austMap = d3.select("#aust-map").append("svg")
					.attr("width", width)
					.attr("height", height)
					.attr("id", "slangMap");

				mapKey = d3.select("#mapKey").append("svg")
							.attr("width", "100px")
							.attr("id", "slangKey");	

				d3.json("data/aus-states.geojson", function(error, mapData) {

					austMap.selectAll(".state")
							.data(mapData.features)
							.enter().append("path")
								.attr("class", "state")
								.attr("d", path)


						d3.csv("data/scallops-count.csv", function(error, data) {

							maxData = d3.max(data, function(a){	return +a.count});
							minData = d3.min(data, function(a){	return +a.count});
							meanData = d3.mean(data, function(a){ return +a.count});

							radiusMultiplier=maxRadius/Math.sqrt(maxData);	

							var wordListTemp = d3.nest()
										.key(function(d){ return d.word})
										.entries(data);

							var wordList = [];			

							console.log(wordList);

							wordListTemp.forEach(function(d) {	
								wordList.push(d.key);
							});		

							console.log(wordList);

							mapKey
								.transition()
								.attr("height", function() { return wordList.length*30 + 20 + "px"});
									
							wordList.forEach(function(d,i) {
								//console.log(d);
								var keyBoxes = mapKey.append("g");

								keyBoxes.append("circle")
								    .attr("class", "keyCircle " + d.replace(" ", "-"))
								    .style("fill",function(d){ return colours[i] } )
								    .attr("cx", 10)
								    .attr("cy", i*20 + 10)
								    .attr("r", 5);

								keyBoxes.append("text")
								    .attr("x", 20)
								    .attr("y", i*20 + 14)
								    .attr("class", "keyText")
								    .text(d);

							});			

							austMap.selectAll(".circle")
									.data(data)
									.enter().append("svg:circle")
										.attr("class",function(d){ return d['word'].replace(" ", "-") + " circle"})
										.style("fill",function(d){ return colours[wordList.indexOf(d['word'])] } )
										.attr("cx",function(d){ return projection([d.lon, d.lat])[0]; })
										.attr("cy",function(d){ return projection([d.lon, d.lat])[1]; })
										.attr('r',function(d){ return Math.sqrt(d.count)*radiusMultiplier })
										.attr("title", function(d){ return d['location-name']})
										.attr("data-count", function(d){ return d.count})
										.attr("data-word", function(d){ return d['word']});


							$(".circle").tooltip({
								track: true,	
						      content: function() {
						        var element = $( this );
								var dCount = element.attr('data-count');
								var dWord = element.attr('data-word');
								var dTitle = element.attr('title');
						        return "<h3>" + dTitle + "</h3>Word: " + dWord + "<br>Count: " +  dCount;
						      }
						    });
				
					});			
			
				});
			}

			drawMap();
			
			if( !/iPhone|iPad|iPod/i.test(navigator.userAgent) ) {

			$(window).resize(function() {

			getW = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
			getH = getW/1.7;
			if (getW > 860) {

			  getW = 860;
			  getH = getW/1.7;

			}
 
			drawMap();

			});


			}




		</script>
	</body>
</html>